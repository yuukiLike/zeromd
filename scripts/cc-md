#!/bin/bash
# cc-md CLI — 查看同步状态、手动同步、健康检查
set -euo pipefail

REAL_PATH="$(readlink "$0" 2>/dev/null || echo "$0")"
SCRIPT_DIR="$(cd "$(dirname "$REAL_PATH")" && pwd)"
STATE_DIR="${CC_MD_STATE_DIR:-$HOME/.cc-md}"

# ---------- 工具函数 ----------

# 将秒数转为人类可读的时间差
human_time() {
    local seconds=$1
    if [ "$seconds" -lt 60 ]; then
        echo "${seconds}s ago"
    elif [ "$seconds" -lt 3600 ]; then
        echo "$(( seconds / 60 ))min ago"
    elif [ "$seconds" -lt 86400 ]; then
        echo "$(( seconds / 3600 ))h ago"
    else
        echo "$(( seconds / 86400 ))d ago"
    fi
}

# 读取 vault 路径
get_vault_dir() {
    if [ -f "$STATE_DIR/vault-path" ]; then
        cat "$STATE_DIR/vault-path"
    else
        echo ""
    fi
}

# 读取 vault 名（basename）
get_vault_name() {
    local vpath
    vpath="$(get_vault_dir)"
    if [ -n "$vpath" ]; then
        basename "$vpath"
    else
        echo "?"
    fi
}

# ---------- 子命令 ----------

cmd_status() {
    local now vault_name pending=0
    now=$(date +%s)
    vault_name="$(get_vault_name)"

    # pending 变更数
    local vault_dir
    vault_dir="$(get_vault_dir)"
    if [ -n "$vault_dir" ] && [ -d "$vault_dir/.git" ]; then
        pending=$(git -C "$vault_dir" status --porcelain 2>/dev/null | wc -l | tr -d ' ')
    fi

    # 心跳检查
    local heartbeat_age=-1
    if [ -f "$STATE_DIR/last-heartbeat" ]; then
        local hb
        hb=$(cat "$STATE_DIR/last-heartbeat")
        heartbeat_age=$(( now - hb ))
    fi

    # 错误检查
    local last_error=""
    if [ -f "$STATE_DIR/last-error" ]; then
        last_error=$(cat "$STATE_DIR/last-error")
    fi

    # daemon 状态
    if [ "$heartbeat_age" -eq -1 ] || [ "$heartbeat_age" -gt 600 ]; then
        # daemon 可能挂了
        if [ "$heartbeat_age" -eq -1 ]; then
            echo "⚠ daemon not running · no heartbeat · vault: $vault_name"
        else
            echo "⚠ daemon not running · last seen $(human_time $heartbeat_age) · vault: $vault_name"
        fi
        return
    fi

    # 有错误
    if [ -n "$last_error" ]; then
        echo "✗ sync error: $last_error · $pending pending · vault: $vault_name"
        return
    fi

    # 正常：显示上次同步时间
    if [ -f "$STATE_DIR/last-sync" ]; then
        local ls_epoch sync_age
        ls_epoch=$(cat "$STATE_DIR/last-sync")
        sync_age=$(( now - ls_epoch ))
        echo "✓ synced $(human_time $sync_age) · $pending pending · vault: $vault_name"
    else
        echo "✓ daemon running · no sync yet · $pending pending · vault: $vault_name"
    fi
}

cmd_log() {
    local n="${1:-20}"
    local log_file="$STATE_DIR/sync.log"
    if [ ! -f "$log_file" ]; then
        echo "No log file found at $log_file"
        return 1
    fi
    tail -n "$n" "$log_file"
}

cmd_sync() {
    bash "$SCRIPT_DIR/sync.sh"
    local rc=$?
    echo ""
    if [ $rc -eq 0 ]; then
        cmd_status
    else
        echo "sync 退出码: $rc"
        cmd_status
    fi
}

cmd_doctor() {
    echo "md doctor"

    local vault_dir
    vault_dir="$(get_vault_dir)"

    # 1. vault 路径
    if [ -n "$vault_dir" ] && [ -d "$vault_dir" ]; then
        echo "  ✓ vault 路径存在: $vault_dir"
    else
        echo "  ✗ vault 路径不存在或未配置"
    fi

    # 2. .git 目录
    if [ -n "$vault_dir" ] && [ -d "$vault_dir/.git" ]; then
        echo "  ✓ Git 仓库正常"
    else
        echo "  ✗ Git 仓库不存在"
    fi

    # 3. remote
    if [ -n "$vault_dir" ] && [ -d "$vault_dir/.git" ]; then
        local remote_url
        remote_url=$(git -C "$vault_dir" remote get-url origin 2>/dev/null || echo "")
        if [ -n "$remote_url" ]; then
            echo "  ✓ Git remote 已配置: $remote_url"
        else
            echo "  ✗ Git remote 未配置"
        fi
    fi

    # 4. launchd
    if launchctl list 2>/dev/null | grep -q cc-md; then
        echo "  ✓ launchd 任务运行中"
    else
        echo "  ✗ launchd 任务未运行"
    fi

    # 5. 心跳
    if [ -f "$STATE_DIR/last-heartbeat" ]; then
        local now hb age
        now=$(date +%s)
        hb=$(cat "$STATE_DIR/last-heartbeat")
        age=$(( now - hb ))
        if [ "$age" -le 600 ]; then
            echo "  ✓ 上次心跳: $(human_time $age)"
        else
            echo "  ⚠ 上次心跳: $(human_time $age)（超过 10 分钟）"
        fi
    else
        echo "  ⚠ 无心跳记录"
    fi

    # 6. 上次同步错误
    if [ -f "$STATE_DIR/last-error" ]; then
        local err
        err=$(cat "$STATE_DIR/last-error")
        if [ -n "$err" ]; then
            echo "  ✗ 上次同步失败: $err"
        else
            echo "  ✓ 上次同步正常"
        fi
    else
        echo "  ✓ 无同步错误"
    fi

    # 7. .git 目录大小
    if [ -n "$vault_dir" ] && [ -d "$vault_dir/.git" ]; then
        local git_size
        git_size=$(du -sh "$vault_dir/.git" 2>/dev/null | cut -f1)
        local size_bytes
        size_bytes=$(du -sk "$vault_dir/.git" 2>/dev/null | cut -f1)
        if [ "${size_bytes:-0}" -gt 102400 ]; then
            echo "  ⚠ .git 目录较大: $git_size"
        else
            echo "  ✓ .git 目录大小: $git_size"
        fi
    fi

    # 8. iCloud 占位文件
    if [ -n "$vault_dir" ] && [ -d "$vault_dir" ]; then
        local icloud_count
        icloud_count=$(find "$vault_dir" -name "*.icloud" 2>/dev/null | wc -l | tr -d ' ')
        if [ "$icloud_count" -gt 0 ]; then
            echo "  ⚠ 发现 .icloud 占位文件: ${icloud_count} 个"
        else
            echo "  ✓ 无 .icloud 占位文件"
        fi
    fi

    # 9. rebase 中断
    if [ -n "$vault_dir" ] && [ -d "$vault_dir/.git" ]; then
        if [ -d "$vault_dir/.git/rebase-merge" ] || [ -d "$vault_dir/.git/rebase-apply" ]; then
            echo "  ✗ Git rebase 中断中，需手动处理"
        else
            echo "  ✓ 无 rebase 中断"
        fi
    fi
}

cmd_init() {
    exec bash "$SCRIPT_DIR/install.sh"
}

cmd_help() {
    cat <<'EOF'
md — iCloud Obsidian vault 的 Git 同步工具

cc-md 让你的 Obsidian 笔记在 iPhone、Mac、Windows 之间自动同步。
Mac ↔ iOS 走 iCloud，Mac ↔ GitHub 走 Git，每 5 分钟自动执行。
本命令是 cc-md 的客户端入口，用来查看状态、排查问题、手动操作。

用法: md <command>

命令:
  status          查看同步状态（默认命令，直接运行 md 等同于 md status）
  log [N]         查看同步日志，N 为行数（默认 20）
  sync            立即执行一次前台同步（不等 5 分钟定时器）
  doctor          健康检查，逐项诊断 9 个检查点
  init            引导式初始化（重新运行 install.sh 安装流程）
  help            显示本帮助信息

status 输出示例:
  ✓ synced 3min ago · 0 pending · vault: notes        正常，3 分钟前同步过
  ✗ sync error: push failed · 5 pending · vault: notes 同步出错，有 5 个未提交变更
  ⚠ daemon not running · last seen 32min ago           后台任务可能挂了

doctor 检查项:
  1. vault 路径是否存在
  2. vault 内 .git 目录是否正常
  3. Git remote 是否已配置
  4. launchd 定时任务是否运行中
  5. 最近一次心跳是否在 10 分钟内
  6. 上次同步是否有错误
  7. .git 目录大小（>100MB 警告）
  8. 是否有 iCloud .icloud 占位文件
  9. 是否有 Git rebase 中断状态

文件与路径:
  ~/.cc-md/vault-path              vault 路径配置
  ~/.cc-md/sync.log                同步日志
  ~/.cc-md/last-heartbeat          最近心跳时间戳（epoch）
  ~/.cc-md/last-sync               最近成功同步时间戳（epoch）
  ~/.cc-md/last-error              最近错误信息（空 = 无错误）
  ~/.cc-md/consecutive-failures    连续失败次数

常见问题:
  同步卡住了？     md doctor 看哪项是 ✗，通常是 rebase 冲突或 push 失败
  后台没在跑？     launchctl load ~/Library/LaunchAgents/com.cc-md.sync.plist
  想换 vault？     重新运行 md init
  想看详细日志？   md log 100

项目地址: https://github.com/anthropics/cc-md
EOF
}

# ---------- 分发 ----------

case "${1:-status}" in
    status)  cmd_status ;;
    log)     cmd_log "${2:-}" ;;
    sync)    cmd_sync ;;
    doctor)  cmd_doctor ;;
    init)    cmd_init ;;
    help|--help|-h)  cmd_help ;;
    *)
        echo "未知命令: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
